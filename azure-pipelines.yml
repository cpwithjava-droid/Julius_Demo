trigger:
- dev

pool:
  name: selfhosted-172

steps:
- checkout: self
  persistCredentials: true
  clean: true

- script: |
    set -e

    echo "Amit Jha"
    git config user.email "cpwithjava@gmail.com"
    git config user.name "Azure DevOps Pipeline"

    echo "Fetching all branches"
    git fetch origin

    echo "Resetting local main to remote main"
    git checkout main
    git reset --hard origin/main

    echo "Merging dev into main"
    if git merge origin/dev --no-edit --allow-unrelated-histories; then
      echo "Merge successful, pushing changes"
      git push origin main
    else
      echo "Merge conflict detected, aborting merge"
      git merge --abort
      exit 1  # Fail or succeed depending on your preference
    fi
  displayName: "Auto merge dev into main"
