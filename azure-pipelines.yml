trigger:
- dev

pool:
  name: selfhosted-172

steps:
- checkout: self
  persistCredentials: true
  clean: true

- script: |
    set -e

    echo "Amit Jha"
    git config user.email "cpwithjava@gmail.com"
    git config user.name "Azure DevOps Pipeline"

    echo "Fetching all branches"
    git fetch origin

    echo "Resetting local main to remote main"
    git checkout main
    git reset --hard origin/main

    echo "Merging dev into main"
    if git merge origin/dev --no-edit --allow-unrelated-histories; then
      echo "Merge successful, pushing changes"
    else
      echo "Merge conflict detected, keeping main's version of ignored files"

      # Take main's version of files you want to ignore
      git checkout --ours azure-pipelines.yml
      git checkout --ours check.txt

      # Stage the ignored files
      git add azure-pipelines.yml check.txt

      # Commit the merge
      git commit -m "Auto merge dev into main, preserving main's pipeline and check.txt"

      echo "Merge conflicts resolved automatically"
    fi

    echo "Pushing merged changes to main"
    git push origin main
  displayName: "Auto merge dev into main (ignore certain files)"
